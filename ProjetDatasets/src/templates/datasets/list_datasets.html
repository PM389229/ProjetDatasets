{% extends "base_generic.html" %}

{% block content %}
<div class="container" style="margin-top: 20px;">
    <form method="GET" action="{% url 'list_datasets' %}" class="form-inline justify-content-center mb-4">
        <input class="form-control mr-sm-2" type="search" placeholder="Rechercher" aria-label="Search" name="q" value="{{ query }}">
        <select class="form-control mr-sm-2" name="file_type">
            <option value="">Tous les types</option>
            <option value="csv" {% if file_type == 'csv' %}selected{% endif %}>CSV</option>
            <option value="json" {% if file_type == 'json' %}selected{% endif %}>JSON</option>
            <option value="jpg" {% if file_type == 'jpg' %}selected{% endif %}>JPG</option>
            <option value="png" {% if file_type == 'png' %}selected{% endif %}>PNG</option>
        </select>
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Rechercher</button>
    </form>

    <div class="row justify-content-center">
        <ul class="list-group col-md-8">
            {% for item in all_results %}
            <li class="list-group-item mb-4 p-4">
                <div class="dataset-info">
                    <h2>
                        {% if item.type == 'text' %}
                            {{ item.metadata.titre }}
                        {% else %}
                            {{ item.metadata.folder_name }}
                        {% endif %}
                    </h2>
                    <p><strong>Type:</strong> 
                        {% if item.type == 'text' %}
                            Texte
                        {% else %}
                            Image
                        {% endif %}
                    </p>
                    <button class="btn btn-info btn-sm mt-2" onclick="toggleInfo('info-{{ forloop.counter }}')">Plus d'infos</button>
                    <div id="info-{{ forloop.counter }}" class="mt-3 card" style="display: none;">
                        <div class="card-body">
                            <p><strong>Chargé le:</strong> {{ item.metadata.HeureChargement }}</p>
                            <p><strong>Taille du fichier:</strong> 
                                {% if item.metadata.file_size %}
                                    {{ item.metadata.file_size|floatformat:2 }} MB
                                {% else %}
                                    Inconnue
                                {% endif %}
                            </p>
                            <p><strong>Description:</strong> {{ item.metadata.description }}</p>
                            <p><strong>Mots Clefs:</strong> {{ item.metadata.mots_clefs|default:"Non spécifiés" }}</p>
                            <p><strong>Type de fichier:</strong> {{ item.metadata.fichier_type }}</p>
                            <p><strong>Chargé par:</strong> {{ item.metadata.Auteur }}</p>

                            <!-- Aperçu déplacé à l'intérieur de "Plus d'infos" -->
                            {% if item.type == 'text' %}
                                <a href="javascript:void(0);" class="btn btn-outline-primary btn-sm mt-2" onclick="toggleSample('sample-{{ forloop.counter }}')">Aperçu</a>
                                <div id="sample-{{ forloop.counter }}" class="mt-3 card" style="display: none;">
                                    <div class="card-body">
                                        <pre>
                                            {% for sample in item.sample %}
                                                {{ sample }}
                                            {% endfor %}
                                        </pre>
                                    </div>
                                </div>
                            {% else %}
                                <a href="javascript:void(0);" class="btn btn-outline-primary btn-sm mt-2" onclick="toggleSample('sample-{{ forloop.counter }}')">Aperçu</a>
                                <div id="sample-{{ forloop.counter }}" class="mt-3 card" style="display: none;">
                                    <div class="card-body">
                                        <div class="image-preview">
                                            {% for image in item.sample %}
                                            {% if item.metadata.fichier_type == 'jpg' or item.metadata.fichier_type == 'jpeg' %}
                                                <img src="data:image/jpeg;base64,{{ image.thumbnail_data }}" alt="{{ image.image_name }}" style="max-width: 100px; max-height: 100px; margin-right: 10px;">
                                            {% elif item.metadata.fichier_type == 'png' %}
                                                <img src="data:image/png;base64,{{ image.thumbnail_data }}" alt="{{ image.image_name }}" style="max-width: 100px; max-height: 100px; margin-right: 10px;">
                                            {% elif item.metadata.fichier_type == 'webp' %}
                                                <img src="data:image/webp;base64,{{ image.thumbnail_data }}" alt="{{ image.image_name }}" style="max-width: 100px; max-height: 100px; margin-right: 10px;">
                                            {% elif item.metadata.fichier_type == 'gif' %}
                                                <img src="data:image/gif;base64,{{ image.thumbnail_data }}" alt="{{ image.image_name }}" style="max-width: 100px; max-height: 100px; margin-right: 10px;">
                                            {% elif item.metadata.fichier_type == 'tiff' %}
                                                <img src="data:image/tiff;base64,{{ image.thumbnail_data }}" alt="{{ image.image_name }}" style="max-width: 100px; max-height: 100px; margin-right: 10px;">
                                            {% endif %}
                                        {% endfor %}                                        
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Actions : Télécharger et Supprimer -->
                <div class="dataset-actions" style="margin-left: auto;">
                    {% if item.type == 'text' %}
                        <a href="{% url 'download_data' collection_name=item.metadata.formatted_titre fichier_type=item.metadata.fichier_type %}" class="btn btn-outline-success btn-sm mt-2">Télécharger</a>
                    {% else %}
                        <a href="{% url 'download_all_images' image_collection_name=item.metadata.folder_name %}" class="btn btn-outline-success btn-sm mt-2">Télécharger</a>
                    {% endif %}

                    {% if is_professor %}
                    <form method="POST" 
                          action="{% if item.type == 'text' %}{% url 'delete_dataset' dataset_id=item.metadata.id %}{% else %}{% url 'delete_image_folder' folder_name=item.metadata.folder_name %}{% endif %}" 
                          style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm mt-2" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce {% if item.type == 'text' %}dataset{% else %}dossier d\'images{% endif %} ?')">
                            Supprimer
                        </button>
                    </form>
                    {% endif %}
                </div>
            </li>
            {% empty %}
            <li class="list-group-item empty">Aucun dataset ou dossier d'images disponible.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
function toggleInfo(id) {
    var infoDiv = document.getElementById(id);
    if (infoDiv.style.display === 'none') {
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

function toggleSample(id) {
    var sampleDiv = document.getElementById(id);
    if (sampleDiv.style.display === 'none') {
        sampleDiv.style.display = 'block';
    } else {
        sampleDiv.style.display = 'none';
    }
}
</script>
{% endblock %}
